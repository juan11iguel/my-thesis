\setchapterpreamble[u]{\margintoc}
\chapter{Towards the optimal coupling and operation of a solar driven \gls{medLabel} system}
\labch{solarmed:optimization}

\tldrbox{
    This chapter describes a method to develop an operational strategy enabling
    the seamless integration of a solar driven \gls{medLabel} system in an
    autonomous and optimal manner, including decisions on when to start or stop
    each subsystem and how to regulate them during operation.

    The method is based on a hierarchical control approach consisting of three
    layers, where the upper operation plan solves a \gls{minlpLabel} problem.
    Results for a week long simulation of the system are compared against two
    alternative strategies: a baseline operation and only operation
    optimization strategies show that the proposed method is able to
    significantly increase the water production by XX \% by taking full
    advantage of the solar resource and flexibility of the thermal storage.    
}

%===================================
%===================================
\section{Introduction}

% Estado del arte de la optimización de procesos de desalación térmica
Most of the literature on automatic control of \gls{medLabel} processes focuses
on low-level control strategies. These are typically based on simple control
loops, using either \gls{pidLabel} controllers~\sidecite{roca_solar_2008a} or
\gls{mpcLabel}~\sidecite{gonzalez_economic_2014a}, with the main objective of
maintaining desired temperature setpoints—primarily the heat source inlet
temperature. A number of works have also addressed optimization of the
\gls{medLabel} process in isolation. For example, Carballo et
al.~\sidecite{carballo_optimal_2018} optimized the steady-state \gls{medLabel}
process using genetic algorithms under different criteria (\eg, maximum
production, highest performance ratio, minimum energy consumption, best
second-law efficiency, and combinations thereof). However, their approach
treated the inlet cooling/seawater flow as a decision variable, which is an
uncontrolled input and thus invalidates the results. The condenser outlet
temperature, which can be regulated through the cooling water flow, would have
been the appropriate decision variable. Similarly, Chorak et
al.~\sidecite{chorak_experimental_2017} experimentally characterized the pilot
plant described in \refch{solarmed:facility} under a wide range of operating
conditions. Their results highlighted how distillate production and thermal
performance are highly sensitive to the chosen operating point: feedwater flow
rate, condenser operating temperature, and heat source temperature have strong
impacts, whereas the system is less sensitive to variations in heat source flow
rate, owing to its sensible heat transfer nature.

There are inherent limitations in optimizing the \gls{medLabel} process in isolation,
without considering the complete system. As explained in \refch{solarmed:std}, an \gls{medLabel}
plant (or any thermal separator) requires two forms of energy: heat and
electricity. Electricity costs can be directly assigned using, for instance,
market prices. For fossil-fuel-based thermal energy, it is straightforward to
relate operating conditions to fuel consumption and cost. However, when thermal
energy is provided by a variable source such as solar, the situation becomes
more complex. Solar availability is intermittent, and both the operation and
efficiency of the solar field depend strongly on how the \gls{medLabel} load is managed.
The two subsystems are intrinsically coupled. This complexity is further
amplified by the presence of thermal storage, which enables time-shifting of
solar energy use and adds another layer of operational decisions.

In short, the true cost of thermal energy in a solar-driven system is difficult
to assess, and achieving optimal \gls{medLabel} operation requires optimizing the entire
coupled system.

Several studies address this broader problem at different levels of complexity.
González~\etal~\cite{gonzalez_economic_2014a} proposed a receding-horizon
optimal control strategy with economic objectives—maximizing water production
while minimizing electricity costs. Their work relied on a simplified linear
model, optimizing only the solar field flow, while fixing the \gls{medLabel} inlet
temperature at a constant value. The most advanced optimization efforts in the
literature, however, have been developed not for \gls{medLabel} but for \fullgls{mdLabel}.

In Porrazzo~\etal~\sidecite{porrazzo_neural_2013}, the authors developed a
neural network-based optimizing control system for a solar-powered seawater \gls{mdLabel}
unit. Because solar energy is intermittent and variable, efficient operation
requires advanced control strategies. A neural network model, trained on
experimental data, was used to capture the relationships between solar
radiation, feed flow rate, inlet water temperature, and distillate production.
This model was then applied to identify optimal feed flow conditions that
maximize distillate output under varying conditions. The proposed feedforward
control strategy was validated through simulations and tested in a pilot plant,
demonstrating improved efficiency.

Gil~\etal~\sidecite{gil_hybrid_2019} extended this approach by recognizing that
a solar \gls{mdLabel} plant does not operate as a single continuous process but transitions
through distinct operating modes (\eg, heating the solar field, charging
the storage tank, or running the \gls{mdLabel} module) dictated by solar and thermal
conditions. In their formulation, the switching logic is predefined: the solar
field is started once irradiance exceeds a threshold, the tank is then charged,
and the \gls{mdLabel} module only begins operation once its inlet temperature reaches a set
value. In other words, the decision of when to start each subsystem is
hardwired into the control rules. As a result, these operating modes are
treated as part of the environment, not as free decision
variables—representing a limitation of the work. To manage the predefined mode
transitions, the authors modeled the facility as a hybrid system and
developed a Hybrid Nonlinear Model Predictive Control (H-PNMPC) scheme. This
framework optimizes flow rates while anticipating and coordinating the fixed
transitions between modes. In doing so, it generalizes the earlier feedforward
optimization into a predictive control framework that incorporates environmental
constraints, enabling more robust operation. Simulation results showed that the
HPNMPC increased operating hours and slightly improved water production compared
to rule-based control. Nevertheless, the choice of optimization
parameters—operation time, operating temperature, and distillate
production—together with the omission of electrical consumption, led to
potentially inefficient outcomes. For instance, the system achieved an 11.31~\%
increase in operating time for only a 1.23~\% gain in production, likely at the
expense of higher auxiliary energy consumption.

Firstly, existing literature on the optimization of \gls{medLabel} plants presents
important limitations. Many studies either consider too few variables, rely on
uncontrollable variables, or use overly simplified models. From the process
analysis in Chapter X, it was concluded that the key controllable variables that
fully define the operating conditions of an \gls{medLabel} plant are: the heat source flow
rate ($q_{med,s}$), the heat source inlet temperature ($T_{med,s,in}$), the
feedwater flow rate ($q_f$), and the condenser outlet temperature
($T_{med,c,out}$). These should therefore serve as the decision variables when
optimizing plant operation. 

Secondly, the objective in optimizing desalination processes is to maximize
distillate production while minimizing the resources required. In solar-driven
processes, the solar resource itself has no direct cost. However, its use
requires electricity to recirculate the working fluid through the solar field.
Since the solar field essentially acts as a solar-to-heat converter, the only
relevant consumption to be minimized in the optimization is the electricity
demand of all system components.

A further consideration, often overlooked in the literature, concerns decisions
on when to start and stop the operation of different subsystems in the presence
of thermal storage. Thermal storage allows heat to be used independently of
solar availability, within certain limits. Depending on its size, this makes the
timing of subsystem operation—solar field and thermal separator—crucial for
maximizing system performance both on the current day and over subsequent days.
Relying on a fixed irradiance threshold to trigger the system startup sequence
is therefore suboptimal, as it ignores the state of thermal storage and
forecasts of solar availability that could enable longer or shorter operation of
the heat source, or earlier or later startup of the load.

% Contribución
In this work, the operation of a solar-driven \gls{medLabel} system is optimized with these
aspects in mind. This is the first study to include explicit decisions on when
to start and stop each subsystem, while also accounting for a two-day prediction
horizon. This allows the optimization to consider not only immediate
performance, but also the impact of present decisions on future production. The
method relies on an experimentally validated system model that incorporates the
electrical consumption of each component, combined with the most comprehensive
data-driven \gls{medLabel} model currently available in the literature.

% Estructura del capítulo
This chapter is structured as follows: first, the optimization problem is
described in \refsec{solarmed:optimization:problem-description}, then the
proposed optimization strategy to solve it is presented in
\refsec{solarmed:optimization:strategy}. The strategy consists on two
fundamental blocks which are detailed in
\nrefsec{solarmed:optimization:op-plan-layer} and
\nrefsec{solarmed:optimization:op-optim-layer}.

%===================================
%===================================
\section{Problem description}
\labsec{solarmed:optimization:problem-description}

The behavior of the \gls{solarmedLabel} process is controlled by acting on two
components, a discrete (operation state) and a continuous one (process variables).

The goal is to design an operational strategy that enables the seamless
integration of both subsystems in an autonomous and optimal manner, including
decisions on when to start or stop each subsystem and how to regulate them
during operation. Therefore, considering the whole system as a
\fullgls{minlpLabel} optimization problem\sidenote{See
\nrefsec{intro:optimization:minlp_problems}} that aims to maximize the water
production while minimizing the (electrical) consumption of the
system. Decisions on when to
operate the system are weighted considering an optimization horizon, approximating the
operation strategy of the system to the optimum:\sidenote{In general $q$ represents flow
rates while $T$ are temperatures. \reffig{solarmed:process-diagram} can be
consulted for subscript reference.}

\marginnote[*5]{$\forall i = 1 \ldots n_{steps}$ is a notation to indicate that
    a condition must be held at every step $i$ in the optimization horizon
    ($n_{steps}$).\\ Bold variables represent vectors.}

\problemdefinitionbox{\gls{solarmedLabel}}{
    \begin{equation*}
        \min_{\mathbf{x},\, \mathbf{e};\, \boldsymbol{\theta}} \quad J = f(\mathbf{x}, \mathbf{e}; \boldsymbol{\theta}) = \sum_{i=1}^{n_{steps}} \left( J_{e,i}-J_{w,i} \right)
    \end{equation*}

    \textbf{with}:
    \begin{align*}
        \quad for\: i &= 1 \ldots n_{steps}: \\
        & \quad J_{w,i}=q_{d,i} \cdot P_{w,i}\:\text{if \textit{valid operation} else 0} \\
        & \quad J_{e,i} = C_{e,i} \cdot P_{e,i} \\
        & \quad q_{d,i},\,C_{e,i},\,\text{valid operation}=\text{solarmed model}(x_{c,i}, x_{p,i}, ...)
    \end{align*}
    \begin{itemize}
        \item Decision variables
        \[
        \mathbf{x} = [\mathbf{med_{mode}},\,\mathbf{sfts_{mode}},\,\mathbf{q_{sf}},\,\mathbf{q_{ts,src}},\,\mathbf{q_{med,s}},\,\mathbf{q_{med,f}},\,\mathbf{T_{med,s,in}},\,\mathbf{T_{med,c,out}}]
        \]
        where $\mathbf{x}_{nx \times \sum{n_{updates,xi}}}=[x_{1,i},\allowbreak\;
        \ldots,x_{1,n_{updates,x_{1}}},\allowbreak\; \ldots,x_{n_x, n_{updates,
        x_{nx}}}]$
        % where $\mathbf{x}=[x_{1,1},\,\ldots\, x_{1,n_{steps}},\, \ldots,\,
        % x_{n_{x},n_{steps}}]$
        
        \item Environment variables
        \[
        \mathbf{e} = [\mathbf{I},\,\mathbf{T_{amb}},\, \mathbf{P_e},\, \mathbf{P_{w}}]
        \]
        where $\mathbf{e}=[e_{1,1},\,\ldots\, e_{1,n_{steps}},\, \ldots,\,
        e_{n_{e},n_{steps}}]$
        
        \item Fixed parameters ??
        \[
        \theta = [R_p = 1,\, R_s = 0,\, \omega_{\text{dc}} = 0]
        \]

    \end{itemize}

    \textbf{subject to}:
    \begin{itemize}
        
        \item Box-bounds
        \begin{itemize}
            \item $\mathbf{med_{mode}} \in [0,1] \subset \mathbb{Z}$
            \item $\mathbf{sfts_{mode}} \in [0,1] \subset \mathbb{Z}$
            \item $\mathbf{q_{sf}} \in [\underline{q_{sf}}, \overline{q_{sf}}] \subset \mathbb{R}$
            \item $\mathbf{q_{ts,src}} \in [\underline{q_{ts,src}}, \overline{q_{ts,src}}] \subset \mathbb{R}$
            \item $\mathbf{q_{med,s}} \in [\underline{q_{med,s}}, \overline{q_{med,s}}] \subset \mathbb{R}$
            \item $\mathbf{q_{med,f}} \in [\underline{q_{med,f}}, \overline{q_{med,f}}] \subset \mathbb{R}$
            \item $\mathbf{T_{med,s,in}} \in [\underline{T_{med,s,in}}, \overline{T_{med,s,in}}] \subset \mathbb{R}$
            \item $\mathbf{T_{med,c,out}} \in [\underline{T_{med,c,out}}, \overline{T_{med,c,out}}] \subset \mathbb{R}$
        \end{itemize}
    \end{itemize}

    \textit{valid operation} conditions, $\forall i = 1 \ldots n_{steps}$:
    \begin{itemize}
        \item $T_{sf,out} \le \overline{T_{sf,out}}$
    \end{itemize}
}

Where the objective is to minimize the cumulative cost of operation ($J$).
Fresh water ($q_{med,d}$) sold ($J_w$) at price $P_w$ is the negative term
while electrical consumptions ($C_e$) at price $P_e$ make up the positive cost
term ($J_e$). The benefit ($B$) of operation is simply the inverse of the cost
of operation.

The environment is represented by the vector $\mathbf{e}$, which includes the
global solar irradiance ($\mathbf{I}$), ambient temperature
($\mathbf{T_{amb}}$), and the prices of water ($\mathbf{P_w}$) and electricity
($\mathbf{P_e}$).

The decision vector $\mathbf{x}$ is composed of the decision variables for both
the discrete and the continuous space. Two decision variables are defined to
manipulate the discrete state of each subsystem defined in
\refsec{solarmed:modelling:discrete}: $\text{med}_{\text{mode}}$ and
$\text{sfts}_{\text{mode}}$. These binary ($\subset \mathbb{Z}$) variables
establish whether the particular subsystem is active ($x_i=1$) or inactive
($x_i=0$). This is directly related to the operation state of the particular
subsystem\sidenote{As defined in
Tables~\ref{tab:solarmed:modelling:sfts_fsm_states} and
\ref{tab:solarmed:modelling:med_fsm_states}}\sidenote{Once the values for these
decision variables are provided, the low-level control layer is in charge of
safely transitioning between operation states \eg $med_{mode}: 0 \rightarrow
1$, med state: \textit{off} $\rightarrow$ \textit{generating vacuum}
$\rightarrow$ \textit{starting-up} $\rightarrow$ \textit{active}} and accounted
for in the models by the integrated finite-state machines as explained in
\refsec{solarmed:modelling:discrete}. For the continuous space, the decision
variables include the ones that define the operating conditions (\ie operation
point) of the \gls{medLabel} system, and the two recirculation flow rates that
determine the conditions of the heat source ($q_{sf}$, $q_{ts,src}$).

%================================
%================================
\subsection{Implementation discussion}
\labsec{solarmed:optimization:implementation}

%==============================
\subsubsection{On the constraint handling}
\labsec{solarmed:optimization:constraints-discussion}

The reader might notice that no constraints are explicitly defined in the
problem definition. This is because the constraints are implicitly defined in
the model equations, which are used to evaluate the objective function. This
design decision is motivated to avoid the need for a constraint-handling
capable optimization algorithm, limiting the choice for an already complex
\gls{minlpLabel} problem\sidenote{See
\nrefsec{intro:optimization:constraints} for a more detailed discussion on the
topic}. Specifically, two aspects demand further consideration:

\begin{enumerate}
    \item The decision value for the \gls{medLabel} outlet condenser
    temperature ($T_{med,c,out}$) is not a direct input to the system, but rather a
    setpoint to be followed by a low-level control loop by manipulating the cooling
    water flow rate ($q_{med,c}$). This input might saturate and thus not be
    able to achieve the desired setpoint. In this case, a new value for the
    decision variable is computed, which is the minimum value that can be
    achieved (with $\overline{q_{med,c}}$). 
    
    In this case, the value used in the \gls{solarmedLabel} and the output from
    the optimization to the low-level control layer would be the validated
    value for $T_{med,c,out}$. No additional actions are needed.

    \item In the solar field, in order to not constantly interrupt the
    evaluation due to the solar field temperature going above
    $\overline{T_{sf,out}}$ (120 $^\circ$C), the model saturates this
    temperature when going above and sets a flag. The limitation of this approach
    is that when there is low energy demand from the
    load, and likely because it favors energy transfer in the heat exchanger
    \sidenote{greater temperature difference in primary side instead of greater mass
    flow rate with its associated increase in pumping power},
    the optimizer tends to minimize the solar field flow, and systematically
    lets the solar field outlet temperature reach the limit. To avoid this
    situation, the positive term of the objective function is nullified in
    iterations where the constraint is not met.
    
    Here, in order to ensure \textit{valid operation} the fitness function is
    manipulated to de-incentivize decision variable values that lead to
    unfeasible operation. 

\end{enumerate}

\subsubsection{On the prediction horizon}
\labsec{solarmed:optimization:decision_variables-discussion}

The problem is designed as an optimization problem with a shrinking
horizon\marginreminder[*-2]{Shrinking horizon optimization}{
An optimization where the horizon end is fixed, and as time progresses, the
start of the horizon moves forward.\footnote{See
\nrefsec{intro:optimization}}
}. The horizon size should be large enough so that
decisions on how to operate the system are made with perspective, taking into
account how they will affect the system in the future, but not so large that
current decisions have no impact on the far future, and making the problem dimensionality become unmanageable. 

For this case study, this parameter should be chosen based
on the hours of capacity of the thermal storage to operate the \gls{medLabel} system.

The thermal storage capacity is XXX which allows the system to operate with no
supply from the solar field for up to XX hours. This means that depending on
the charge state of the thermal storage, the system could start operation
independently of the irradiance conditions, or operate at different levels of
temperature. Considering this the optimization horizon,
in time units, chosen was 36 hours. This means that if the optimization is evaluated at
5:00 on day 1, the fitness function is evaluated until 19:00 of day 2 \ie
including the end of operation for day 2. 

%===================================
%===================================
\subsubsection{On solving the optimization problem}
\labsec{solarmed:optimization:solving-discussion}

Solving the optimization problem for this \fullgls{minlpLabel} formulation
presents significant challenges due to the combinatorial nature of the integer
decision variables~\sidecite{grossmann_advanced_2021}. As shown in
\reffig{solarmed:optimization:decision_tree}, each combination of integer
decisions, such as the operational modes of the separation subsystem
($med_{mode}$) and the solar field thermal storage subsystem ($sfts_{mode}$),
leads to a different system trajectory along the prediction
horizon\sidenote{This will be referred to as: \textbf{operation plan}}.

The number of possible operation trajectories increases exponentially with both
the number of integer variables ($n_{xi}$) and the number of decision updates
($n_{\text{updates}, xi}$), following the expression\sidenote{For example: 
$n_{\text{updates}, \forall xi}=6 \rightarrow n_{problems} = 64$,
$n_{\text{updates}, \forall xi}=24 \rightarrow n_{problems} = 16\,777\,216$}:

\begin{equation}
    \labeq{solarmed:optimization:n_problems}
    n_{\text{problems}} = n_{xi}^{n_{\text{updates}, xi}}.
\end{equation}

This exponential growth makes the search space extremely large and complex.

An important design consideration when solving the optimization problem is
whether the sequence of integer decisions (\ie, operational mode transitions
over time) is predefined or whether the optimization algorithm is allowed to
explore the decision tree freely and determine the optimal sequence. The latter
case requires more computational effort but allows for potentially better-performing
solutions by dynamically adjusting to system conditions.


\subsubsection{On the decision variables update frequency}
\labsec{solarmed:optimization:decision_variables-discussion}

Apart from the integer decision variables, if a fixed decision variable update
frequency is chosen for all continuous decision variables, the size of the
decision vector for a large horizon like the one chosen can become large with
diminishing returns. Instead, a new design parameter is introduced: the number
of decision variable updates ($n_{updates, x_i}$) for each decision variable in
the optimization problem.

Thus, the decision vector is formed by each individual decision variable repeated as
many times as updates for it:
\[ 
    X_{nx \times\sum{n_{updates,xi}}}=[x_{1,k},\allowbreak\;
    \ldots,x_{1,n_{updates,x_{1}}},\allowbreak\; \ldots,x_{n_x, n_{updates,
    x_{nx}}}]
\]

The number of updates of the decision variable ($n_{updates, x_i}
\in [1,n_{steps}]$) can be chosen individually. More updates are assigned to
variables regulating faster dynamics ($q_{sf}$, $q_{ts,src}$), and these
updates of the decision variables are evenly distributed throughout the \textit{active}
period of the subsystem within the horizon. This is a crucial design
consideration since otherwise the limited number of updates would be assigned
to long inactive periods (between end of operation in day 1 and start on day
2). 
\begin{marginfigure}[-10cm]
    \includegraphics[]{solarmed-optimization-decision_tree.png}
    \caption{Decision tree resulting from the combinatorial nature of the integer part of the optimization problem. Text in nodes represents system states.}
    \labfig{solarmed:optimization:decision_tree}
\end{marginfigure}

It also means that the continuous component of the decision vector can only be
assigned timestamps after the integer part is defined.
Once timestamps are associated with each decision variable, the decision vector
values can be resampled to match the desired sampling time of the optimization
problem. This is done by forward filling \cite{hyndman_forecasting_2021}
the values of the decision vector until the next update time. 

%===================================

\section[]{Proposed optimization strategy}[Proposed strategy]
\labsec{solarmed:optimization:strategy}

A hierarchical control approach (see
\reffig{solarmed:optimization:architecture}) was chosen consisting of
three layers: operation plan, operation optimization, and control.
This scheme was chosen for two main reasons. On the one hand, the time scales
of the different aspects of the operation of the system (operation mode
changes, process variables setpoint changes, regulatory control, respectively)
can differ substantially. Secondly, it allows to abstract process complexity
from the more computationally demanding upper layers by allocating it into the
downstream layers. The operation plan layer makes decisions for the \textit{operation
modes}, the operation optimization layer sets the setpoints given to the
continuous \textit{process variables} that are to be followed by the low-level
regulatory control layer.

\begin{marginfigure}[-3.5cm]
    \includegraphics[]{solarmed-optimization-architecture.png}
    \caption{Proposed optimization strategy architecture}
    \labfig{solarmed:optimization:architecture}
\end{marginfigure}

Both operation plan and operation optimization layers share the same underlying
problem structure, the difference being that the operation plan layer evaluates
a predefined library of $\text{n}_{\text{problems}}$ combinations of the binary
decision variables $\text{med}_{mode}$ and $\text{sfts}_{mode}$ twice; once to
decide the operation start, and another to end operation. The operation
optimization layer periodically solves a single \gls{nlpLabel} problem with the
selected values for these two variables fixed. They are further described in
the following sections.

% This layered optimization procedure is illustrated in
% \reffig{solarmed:optimization:architecture} where it can be seen that the
% proposed strategy is composed by an ordered sequence of evaluations of the
% different layers. 

\section{Operation plan layer description}
\labsec{solarmed:optimization:op-plan-layer}

\marginnote{The number of updates available for each integer variable
$n_{updates,xi}$ will be interchangeably referred to as \fullgls{dofLabel}.}

This layer determines the integer decision variables of the \gls{minlpLabel}
problem, namely, the sequence of operation modes producing an operation plan. 
To make the problem computationally
tractable, only a limited number of combinations, $n_{problems}$, are
evaluated. This transforms the mixed-integer problem into a simpler form by
moving the integer variables from the decision to the environment space.
In effect, the original \textbf{\gls{minlpLabel}} is decomposed into a library
of \textbf{n\gls{nlpLabel}} problems that are individually
evaluated\sidenote{\textbf{\gls{minlpLabel}} $\rightarrow$ \textbf{n\gls{nlpLabel}}}.

% As mentioned, two evaluations of this layer are performed at different times:
% one to plan subsystem start-up, and another to schedule shutdown.  

To improve robustness, the layer can be evaluated multiple times ($n_{evals}$)
under different scenarios—typically reflecting variations in forecasted
environmental conditions. The final operation plan is selected as the best
compromise across these scenarios.

The time required to perform this layer’s computation is denoted
$\Delta t_{eval,plan}$.

\subsection{Candidate problems generation}

Given the available computational resources and the complexity of the objective
function, it has been found feasible to evaluate in the order of $n_{problems}
\sim 100$ candidate combinations. This constraint informs how many
\fullgls{dofLabel} (\ie number of updates available for the operation modes)
can be defined by using \refeq{solarmed:optimization:n_problems}. The
particular design choice for the number of updates per subsystem is shown in
\reftab{solarmed:optimization:dof}. In total, 101 distinct operation plans are
generated for the start-up evaluation and 144 for the shutdown\sidenote[][*-5]{Notice
the total number does not match exactly \refeq{solarmed:optimization:n_problems} since
special cases are added (subsystem inactive)}.

\begin{table}[htbp]
\centering
\caption{Operation plan. Start-up (1) and shutdown (2) degrees of freedom for changes in the operation state.}
\labtab{solarmed:optimization:dof}
\resizebox{\textwidth}{!}{%
\begin{tabular}{lrrccccccclc}
\cline{2-12}
 & \multicolumn{1}{c}{\multirow{3}{*}{\textbf{Subsystem}}} &  & \multicolumn{7}{l}{\textbf{Degrees of freedom}} &  & \multirow{3}{*}{$\textbf{n}_{\textbf{problems}}$} \\ \cline{4-10}
 & \multicolumn{1}{c}{} &  & \multicolumn{3}{l}{Day 1} &  & \multicolumn{3}{l}{Day 2} &  &  \\ \cline{4-6} \cline{8-10}
 & \multicolumn{1}{c}{} &  & Start &  & Stop &  & Start &  & Stop &  &  \\ \cline{2-2} \cline{4-4} \cline{6-6} \cline{8-8} \cline{10-10} \cline{12-12} 
\multirow{2}{*}{Evaluation: Start-up (1)} & sfts &  & 3 &  & 3 &  & 1 &  & 1 &  & \multirow{2}{*}{101} \\
 & med &  & 3 &  & 3 &  & 1 &  & 1 &  &  \\ \cline{2-12} 
\multirow{2}{*}{Evaluation: Shutdown (2)} & sfts &  & - &  & 3 &  & 2 &  & 2 &  & \multirow{2}{*}{144} \\
 & med &  & - &  & 3 &  & 2 &  & 2 &  &  \\ \cline{2-12} 
\end{tabular}%
}
\end{table}


\subsection{Update times generation}

Up to this stage the operation plans generated just consist of a list of ones
and zeros for each subsystem, indicating whether the subsystem is active or
inactive in the particular update. The next step is to assign the operation
mode updates to specific time instants, which then can be resampled to match
the desired sampling time of the optimization problem\sidenote{As with the
continuous component of the decision vector, this is done by forward filling
\cite{hyndman_forecasting_2021} the values of the decision vector until the
next update time. This is also known as \textit{Last Observation Carried Forward}}.

In order to maintain the solution close to the optimal one, while keeping the
number of problems reasonable, decision updates are distributed throughout the
prediction horizon at strategic time instants. Since the case study system is
fundamentally a solar process, the operation is strongly dependent on the
irradiance availability, and thus operation changes are likely to take place at
the start and end of the solar day. 

The operation mode updates are distributed temporally as shown in
\reffig{solarmed:optimization:operation_plan} (b) depending on the number of
updates available (\gls{dofLabel}). These update times are dependent on the
solar irradiance profile and are bounded by lower- and upper-level thresholds.
Depending on the plan action (start-up or shutdown), they are named early-late
start or early-late stop thresholds, respectively.

In \reffig{solarmed:optimization:operation_plan} (b) up to three \gls{dofLabel}
are visualized. If only one update is available, the update time is set at the
mean of the early and late thresholds. If two \gls{dofLabel} are available, for
the \gls{sftsLabel} subsystem, they are placed halfway between the early
threshold and the mean, and the late threshold and the mean, respectively. For
the \gls{medLabel} subsystem, updates are delayed. Finally, with three
\gls{dofLabel}, updates for the \gls{sftsLabel} subsystem are placed at the
early, mean and late thresholds, while for the \gls{medLabel} subsystem, the
leftmost and rightmost updates are shifted to the left and right, respectively.
If more updates for the particular action are available \ie \gls{dofLabel},
additional thresholds can be added.

\begin{figure*}
    \centering
    \subfloat[\centering Computation timeline]{{\includegraphics[width=0.48\linewidth]{solarmed-optimization-timeline.png}}}%
    \hspace{0.01\linewidth}
    \subfloat[\centering Operation mode updates time distribution]{{\includegraphics[width=0.48\linewidth]{solarmed-optimization-updates_distribution.png}}}%
    \caption[Operation plan layer computation and updates distribution]{Operation plan layer computation and updates distribution. The yellow line represents the irradiance illustrating the solar day.}%
    \labfig{solarmed:optimization:operation_plan}
\end{figure*}


Given a number of updates per subsystem and the update times assigned. The
potential operation time change candidates are defined as:

\[
    t_{mode-change,candidates} = [t_0,\, t_1,\, \ldots,\, t_{max(n_{updates,\forall x_i})}]
\]

Ordered in ascending order, where $t_0$ is the earliest potential operation
change time and $t_{max(n_{updates,\forall x_i})}$ is the latest potential
operation change time. Based on this definition, the earliest potential
subsystem start-up would be at $t_{\uparrow, candidates}(0)$. Similarly, the earliest
potential shutdown would be at $t_{\downarrow, candidates}(0)$.

\subsubsection{Start-up}
\labsec{solarmed:optimization:operation_plan:start-up}

The most important aspect of this evaluation is to find the right time to bring
the subsystems online, and secondary is to provide a preliminary estimate for
their shutdown timing.

This is the first evaluation of the proposed methodology (see
\reffig{solarmed:optimization:architecture}) and is computed ahead of the first
potential operation mode change (\reffig{solarmed:optimization:operation_plan}
(a) - \textit{start-up}), with enough lead time to complete the analysis before
any potential change in operation mode ($t_{\uparrow,candidates}(0)$):

\[
    t=t_{\uparrow,candidates}(0) - (\Delta t_{eval,plan}\times n_{evals})
\]

Being the earliest evaluation, it has the longest prediction horizon and thus
the highest predicted variables uncertainty. As a counterpart, as shown in
\reffig{solarmed:optimization:operation_plan} (a), this early evaluation start
allows sufficient computation time, even several hours in advance, to perform
several evaluations. Specifically three evaluations ($n_{evals}$) are performed: a
nominal scenario with the forecasted environmental conditions, a pessimist one
with a 20\% decrease in the expected solar irradiance and finally an optimist
one with a 20\% increase in the expected solar irradiance.


\subsubsection{Shutdown}

A second evaluation is performed later in the day (see
\reffig{solarmed:optimization:architecture}), before system shutdown. This
aims to determine the most suitable time to stop operations using the most
recent system state information. It includes \gls{dofLabel} regarding the
operation schedule for the following day, allowing the shutdown decision for
day 1 to account for its impact on the start and end times of day
2\sidenote{See \reftab{solarmed:optimization:dof}}. 

Only one evaluation is performed, as the uncertainty in the prediction horizon
is significantly lower than in the start-up evaluation. It is evaluated in
parallel to the operation optimization layer and just before the earliest
expected shutdown time of the subsystems from
\nrefsec{solarmed:optimization:operation_plan:start-up},
$t_{\downarrow,candidates}(0)$, considering subsystem shutdown.

\[
    t=t_{\downarrow,candidates}(0) - (\Delta t_{eval,plan} \times some number)
\]

Once computed the integer decision are updated in this layer. The faster the
computation the better, since it will allow the operation optimization layer to
optimize operation for the actual shutdown time and adapt accordingly.

\section{Operation optimization layer description}
\labsec{solarmed:optimization:op-optim-layer}

As mentioned, this middle layer establishes the setpoints for the continuous
process variables, \ie the continuous part of the \gls{minlpLabel} problem. The
operation optimization layer evaluates periodically, with a sample time
$T_{eval,optim}$, a \gls{nlpLabel} problem where the integer decision variables
are fixed to the values provided by the operation plan layer\sidenote{It is
exactly equivalent to the operation plan layer problem, just making
$n_{problems}=1$}. It uses the latest available state of the system and
environment predictions to evaluate the objective function.

The layer computation time is named $\Delta t_{eval,optim}$.

\begin{kaobox}[title=\gls{solarmedLabel} optimization methodology]

    \begin{enumerate}
        \item Generate operation mode change candidates based on the available
        updates per subsystem and irradiance thresholds.
        \item Before the first potential operation change and considering the
        evaluation time, $t=t_{\uparrow,candidates}(0) - (\Delta
        t_{eval,plan}\times n_{evals})$, evaluate the operation plan layer to
        establish the operation start of the subsystems and an estimation of
        when to stop.
        
        \item Before the established startup and considering the layer evaluation time, $t=t_{\uparrow} - \Delta
        t_{eval,optim}$, start evaluating the operation optimization layer
        periodically ($T_{eval,optim}$) to establish the setpoints for the
        continuous process variables.

        \item Before the earliest subsystem projected shutdown and considering
        the operation optimization layer evaluation time,
        $t=t_{\downarrow,candidates}(0) - \Delta t_{eval,plan}$, evaluate
        the operation plan layer, in parallel to the operation optimization layer,
        to establish the shutdown time of the subsystems.

        \item Continue evaluating the operation optimization layer periodically
        ($T_{eval,optim}$) until the last subsystem is shutdown.
    \end{enumerate}

\end{kaobox}