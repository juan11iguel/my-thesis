\setchapterpreamble[u]{\margintoc}
\chapter{Hybrid modelling of a solar driven \gls{medLabel} system}
\labch{solarmed:modelling}


%===================================
%===================================
\section{Introduction}

The behavior of the \gls{solarmedLabel} process is controlled by acting on two
components, a continuous and a discrete one, described
\nrefsec{solarmed:modelling:dynamic} and \nrefsec{solarmed:modelling:discrete},
respectively. Then, they are combined to create a complete model of the
\gls{solarmedLabel} process.

% The continuous-dynamic behavior of the process is described by a
% set of differential equations, while the discrete behavior is described by
% \glspl{fsmLabel}. The \glspl{fsmLabel} are used to model the
% operation state of the system while the process variables describe the
% continuous-dynamic behavior.

\begin{itemize}
    \item Operation state. 
    \item Process variables. Regulates the continuous-dynamic behavior of the process. Specifically, two recirculation flow rates for the sfts subsystem, five flow and temperature variables for the MED.
\end{itemize}

%===================================
%===================================
\section{Dynamic modelling. Process variables}[Dynamic modelling]
\labsec{solarmed:modelling:dynamic}

The dynamic behavior of the \gls{solarmedLabel} regulates the values of the
different process variables. This behaviour is modelled by integrating a set of
models for each component of the \gls{solarmedLabel} system.

Even though this modelling component models the dynamic behavior of the system,
many of the models described in the following sections are steady-state models.
This can lead to discrepancies between the model predictions and the actual
system behavior, particularly during transient events. However, this is not
deemed a significant limitation since the model is intended to be used for an
optimization approach where the model sample rate is in the order of minutes,
and inputs for slower component dynamics are changed sparingly, typically
starting from 30 minutes and above, more than enough time for the system to
reach steady state.

%===================================
%===================================
\subsection{\fullgls{sfLabel}}

% Describe input and outputs
The solar field is basically a converter of electrical to thermal energy
dependent on the irradiance availability. The two main outputs, in terms of
operation of the solar field, are the conversion factor ($kW_{e}/kW_{th}$)
and the temperature the heat is obtained.

The diagram illustrates the individual loops that make up the field. In the
model, it is assumed that all loops have equal flow rates and temperatures
(\ie, a balanced flow distribution). As a result, the system can be simplified
to a single loop with a collector area equal to the sum of the areas of the
individual loops.

% References
A first-principles based on the one presented in Ampuño et
al.~\sidecite{ampuno_modeling_2018} is used to model the solar field. The model
has two types of parameters: dynamic and constant. The dynamic parameters are
the thermal loss coefficient ($H\,\left( \frac{J}{s·^\circ C} \right)$) and
the collector efficiency factor ($\beta\,(m)$), which are calibrated based on
experimental data. The constant parameters are the ones defined in 


% Bloque de modelo con interfaz y ecuaciones
\begin{modelcounter}{Solar field}
    \begin{align*}
        T_{\text{out}}(k) & \text{sf\:model}\left(
            T_{\text{out}}(k\!-\!1),\,
            \mathbf{T}_{\text{in}}[k\!-\!n : k],\,
            \boldsymbol{\dot{m}}[k\!-\!n : k],\,
            I(k),\,
            T_{\text{amb}}(k);\,
            \beta,\,
            H
        \right) \\
        & C_{hx,p} = \dot{m}_{hx,p} \cdot c_{p,Tp,in} \\
        & C_{hx,s} = \dot{m}_{hx,s} \cdot c_{p,Ts,in} \\
        & C_{min} = min(C_{hx,p}, C_{hx,s}) \\
        & C_{max} = max(C_{hx,p}, C_{hx,s}) \\
        & C=\frac{C_{min}}{C_{max}} \\
        & NTU = UA / C_{min} \\
        & \epsilon = \frac{1 - e^{ (-NTU \cdot (1 - C))}}{1 - C \cdot e^{-NTU \cdot (1 - C)}} \\
        & T_{hx,p,out} = T_{hx,p,in} - (\dot{Q}_{max} * \epsilon) / (C_{hx,p}) \\
        & T_{hx,s,out} = T_{hx,s,in} + (\dot{Q}_{max} * \epsilon) / (C_{hx,s}) \\
    \end{align*}

    \labmod{solarmed:sf}
\end{modelcounter}

% Diagrama del componente con variables
\begin{marginfigure}[-5.5cm]
    \includegraphics[]{figures/solarmed-diagrams-solar_field_compact.png}
    \caption{Solar field process diagram.}
    \labfig{solarmed:diagrams:solar_field}
\end{marginfigure}

The main difference with respect to the model presented in is how the apparent transport delay is handled~\sidecite{ampuno_apparent_2019}\sidenote{
    Transport delays are a common feature in dynamic systems, where the
    response of the system to an input is not instantaneous, but rather
    delayed by a certain amount of time. This delay can be caused by various
    factors, in this particular system, is due to the time it takes for the
    water to flow through the solar field and reach the temperature sensors.
}. In this implementation, the transport delay is simplified to a single
parameter based on the work presented in Normey-Rico et.al~\sidecite{normey-rico_robust_1998}. 

%================================
\subsubsection{Electrical consumption}

\begin{definition}
    \textbf{Step train test}. Variations in the \gls{vfdLabel} pump speed
    from a minimum to a maximum value, with fixed increments.
\end{definition}

% Explicar configuración/situación hidráulica del campo
The \textit{AQUASOL} solar field is composed by a set of pumps that recirculate
the water through the solar field. The pumps are controlled by \glspl{vfdLabel}
that allow to vary the flow rate through the solar field. A main recirculation
pump ($P_{l0}$) is responsible for the primary flow, while additional pumps
($P_{l1}$, $P_{l2}$, etc.) are used in the individual loops to either increase
the total flow rate or to operate with the isolated loop. This redundancy means
that the same flow rate can be achieved with different pump configurations.

% Mostrar ensayo para caracterizar el consumo eléctrico del campo solar
Then, prior to modelling the electrical consumption of the solar field, a prior
step is to characterize the electrical consumption of the system. This is done
by determining the relationship between flow rate and power consumption for
every configuration and to find the best configuration, that is, the one that
minimizes the electrical consumption across the range of flow rates that the
solar field operates at.

% Gráfica bonica para test 20240927 y 20240925 (unir ambos ensayos en el mismo
% dataframe y romper el eje x para evitar la discontinuidad grande entre días)
\begin{figure*}[h!]
    \includegraphics[]{figures/solar_field_eletricity_caractherization_tests.png}
    \savebox\captionqr{\qrcode[hyperlink,height=0.5in]{\repositoryBaseUrl/figures/sf_tests_viz.zip}}
    \caption{Solar field and thermal storage electrical
    characterization tests.\hspace{1ex}\usebox\captionqr}
    \labfig{solarmed:modelling:sf:electrical_consumption_tests}
\end{figure*}


% Describir metodología del ensayo

% Results
In order to characterize the electrical consumption of the solar field, a
series of tests were performed as can be seen in
\reffig{solarmed:modelling:sf:electrical_consumption_tests}. The tests were
carried out in two different dates since they have to be performed early,
before the solar field is irradiated by the sun and the field heats
up\sidenote{observe the trend in
\reffig{solarmed:modelling:sf:electrical_consumption_tests} -
\textit{Temperatures}}. In the first day, step trains are applied to the main
loop and individual isolated loops (20240925 07:15 - 08:30). On the second day,
different speeds levels were set for the main recirculation pump (10\% - 100\%,
10\% increments) while step trains were applied to the individual loops (40\% -
100\%, 20\% increments)\sidenote{In
\reffig{solarmed:modelling:sf:electrical_consumption_tests}, from 20240927
07:35 to 08:20}.

% Flow vs power consumption
\begin{figure}
    \includegraphics[width=\textwidth]{figures/sf_flow_vs_power_consumption.png}
    \savebox\captionqr{\qrcode[hyperlink,height=0.5in]{\repositoryBaseUrl/figures/sf_flow_vs_power_consumption.html}}
    \caption{Solar field flow for different pump configurations and their associated power consumption.\\[1ex] \usebox\captionqr}
    \labfig{solarmed:modelling:sf:flow_vs_power_consumption}
\end{figure}

% Describir selección de configuración para finalmente realizar calibración
\reffig{solarmed:modelling:sf:flow_vs_power_consumption} shows the relationship
between flow rate and power consumptions for different configuration and pump
speeds. Up to 90 l/min the best configuration is to just use the main
recirculation pump. Above this flow rate, the main pump is used in combination
with the individual loops. First a combination of main pump from 85 to 100\%
and individual loops at their 40\% minimum speed, then the main pump at 100\%
and individual loops at increasing values up to 100\%. With this selection, a
two degree order polynomial regression is fitted to the data, as shown in
\reffig{tobeadded3}.

Summarizing, the electrical consumption of the solar field is modelled as a
function of the flow rate through the solar field from a minimum value of XX
m$^3$/h to a maximum value of YY m$^3$/h. This is achieved as a result of the
combination of the main recirculation pump and the individual loops.


% 

%================================
\subsubsection{Validation}

% Plot or table?

% Probably a table with the elapsed time, MAE and R2 for the validation days

% Plot with timeseries validation for one exemplary day


%===================================
%===================================
\subsection{Thermal storage}

%================================
\subsubsection{Electrical consumption}

% Mostrar ensayo, si encaja incluirlo en la misma gráfica que el campo solar
% simplemente referenciar esa figura

%================================
\subsubsection{Validation}

%===================================
%===================================
\subsection{Heat exchanger}

The solar field and thermal storage are interfaced by a \gls{hexLabel},
particularly a counter-flow heat exchanger. The component is modelled using a first-principles
steady state model based on the effectiveness-NTU
method\sidecite{cengel_heat_2015,kays_compact_1958}.

Modelling considerations \cite{cengel_heat_2015}: 
\begin{itemize}
    \item It has been assumed that the rate of change for the temperature of both fluids is proportional to the temperature difference; this assumption is valid for fluids with a constant specific heat, which is a good description of fluids changing temperature over a relatively small range. However, if the specific heat changes, the \gls{lmtdLabel} approach will no longer be accurate. 
    \item It has also been assumed that the heat transfer coefficient (U) is constant, and not a function of temperature.
    \item No phase change during heat transfer.
    \item Changes in kinetic energy and potential energy are neglected.
\end{itemize}


% Bloque de modelo con interfaz y ecuaciones
\begin{modelcounter}{Heat exchanger}
    \begin{align*}
        T_{hx,p,out},\,T_{hx,s,out}& = \text{hx\:model}(T_{hx,p,in},T_{hx,s,in},\dot{m}_p,\dot{m}_{s}, T_{amb}, (UA)_{hx}, H) \\
        & C_{hx,p} = \dot{m}_{hx,p} \cdot c_{p,Tp,in} \\
        & C_{hx,s} = \dot{m}_{hx,s} \cdot c_{p,Ts,in} \\
        & C_{min} = min(C_{hx,p}, C_{hx,s}) \\
        & C_{max} = max(C_{hx,p}, C_{hx,s}) \\
        & C=\frac{C_{min}}{C_{max}} \\
        & NTU = UA / C_{min} \\
        & \epsilon = \frac{1 - e^{ (-NTU \cdot (1 - C))}}{1 - C \cdot e^{-NTU \cdot (1 - C)}} \\
        & T_{hx,p,out} = T_{hx,p,in} - (\dot{Q}_{max} * \epsilon) / (C_{hx,p}) \\
        & T_{hx,s,out} = T_{hx,s,in} + (\dot{Q}_{max} * \epsilon) / (C_{hx,s}) \\
    \end{align*}

    \labmod{solarmed:hex}
\end{modelcounter}

% Diagrama del componente con variables
\begin{marginfigure}[-5.5cm]
    \includegraphics[]{figures/solarmed-diagrams-heat_exchanger.png}
    \caption{Heat exchanger process diagram.}
    \labfig{solarmed:diagrams:heat_exchanger}
\end{marginfigure}

Where $p$ references the primary circuit (solar field side) and $s$ the
secondary circuit (thermal storage side). As shown in the
\refmod{solarmed:hex}, first the heat capacity $C$ is determined in order to
calculate the effectiveness ($\epsilon$) of the heat exchanger. Finally, after
determining the maximum heat transfer rate ($\dot{Q}_{max}$), the outlet temperatures
can be obtained.



%================================
\subsubsection{Validation}

In order to calibrate the two parameters of this model ($UA$ and $H$), one
experimental test used where the parameters are varied in order to minimize the
error between the model and the experimental data. The obtained values are
shown in \reftab{} and the dynamic behavior of the model is shown in \reffig{}.
It can be seen than the model performs fairly well even in transient conditions,
with a mean absolute error of XX\% and a coefficient of determination $R^2$ of
YY\%. 

Several more tests are evaluated and the performance obtained is shown in
\reftab{}. On average, the model has a mean absolute error of XX\% and a coefficient
of determination $R^2$ of YY\%. The model is able to predict the outlet
temperatures of the heat exchanger with a good accuracy, even in transient
conditions, which is a good indication of the model's reliability.

%===================================
%===================================
\subsection{\gls{medLabel}}

The \gls{medLabel} is modelled statically, that is, considering that changes in
the system operating conditions happen at a slow enough rate that the dynamic
behavior between stable states can be neglected, and thus, only those stable
states are considered. The model is a data driven one, specifically an
\gls{annLabel} that has been trained with data from en experimental campaign in
the pilot plant\sidenote{Referencia a donde se mencione o algún artículo de Patricia}.

%================================
\subsubsection{Electrical consumption}


%================================
\subsubsection{Validation}


%===================================
%===================================
\subsection{Other components}

%===================================
\subsubsection{Three-way valve}


%===================================
%===================================
\section{Discrete modelling. Operation state}[Discrete modelling]
\labsec{solarmed:modelling:discrete}

The second modelling component defines the discrete state of the system, that
is, its \textit{operation state}. This component is modelled by means of
\glspl{fsmLabel}.

\reminder{\glspl[format=long]{fsmLabel}}{
    A finite state machine is a model of behavior composed of a finite number of
\textit{states} and \textit{transitions} between those states. Within each
state and transition some \textit{action} can be performed\footnote{See
    \nrefsec{intro:modelling:fsm} for a more detailed description.}.
}

The complete system is divided into two subsystems: the heat generation and
storage subsystem and the separation subsystem.

%================================
\subsection{Heat generation and storage subsystem (\texttt{sfts})}
\labsec{solarmed:modelling:sfts_fsm}

This subsystem encompasses the \fullgls{sfLabel} and the \fullgls{tsLabel}. The
subsystem can be modelled with a simple \gls{fsmLabel} as shown in \reffig{},
where the states are defined based on whether water is being recirculated in
each circuit. Four states are defined as shown in \reftab{solarmed:modelling:sfts_fsm_states}.

\begin{margintable}[*-3]
\caption{\gls{sftsLabel} \gls{fsmLabel} states definitions. $\land$ represents
the logical \texttt{AND} operator and $\forall$ represents that all meet the condition.}
\labtab{solarmed:modelling:sfts_fsm_states}
\resizebox{\linewidth}{!}{%
\begin{tabular}{cll}
    \toprule
    \textbf{State} & \textbf{Name} & \textbf{Condition}  \\
    \midrule
    0 (00) & Off & $q_{sf}\land q_{ts,src}==0$ \\
    1 (01) & Warming up \gls{sfLabel} & $q_{sf} > 0 \land q_{ts,src}==0$ \\
    2 (10) & Recirculating \gls{tsLabel} & $q_{sf} ==0 \land q_{ts,src} > 0$ \\
    3 (11) & \gls{sfLabel} heating up \gls{tsLabel} & $q_{sf}\land q_{ts,src} > 0$
    \\
    \bottomrule
\end{tabular}
}
\end{margintable}

% Figura de la máquina de estado finito y gráfica con la evolución de estados
% durante un ensayo

%================================
\subsection{Separation subsystem (\texttt{med})}
\labsec{solarmed:modelling:med_fsm}

% Figura de la máquina de estado finito y gráfica con la evolución de estados
% durante un ensayo

\begin{margintable}[*-3]
\caption{\gls{medfsmLabel} \gls{fsmLabel} states definitions. $\land$ represents
the logical \texttt{AND} operator, $\exists$ represents that at least one meets
the condition, and $\forall$ represents that all meet the condition.}
\labtab{solarmed:modelling:med_fsm_states}
\resizebox{\linewidth}{!}{%
\begin{tabular}{cll}
    \toprule
    \textbf{State} & \textbf{Name} & \textbf{Condition}  \\
    \midrule
    0 & Off & $\forall q == 0$ \\
    1 & Generating vacuum & $\text{med}_{vac} == 2$ \\
    2 & Idle & $\forall q == 0 \land \text{med}_{vac} == 1$ \\
    3 & Starting-up & $\forall q > \underline{q} \land \text{med}_{vac} \ge 1 \land \forall T >
    \underline{T} $ \\
    4 & Shutting down & $\exists$ q < \underline{q} \\
    5 & Active & $\forall q > \underline{q} \land \text{med}_{vac} \ge 1 \land \forall T >
    \underline{T} $\\
    \bottomrule
\end{tabular}
}
\end{margintable}

\section{Complete system model}

Aquí describir cómo se combinan los componentes en función del estado del
sistema y cómo ello depende de las máquinas de estado finito.

To refer to the operational state of the system, a three digit number is used,
where the first two digits represent the \gls{sftsLabel} state and the last one
the \gls{medfsmLabel} state. For example, the state \texttt{005} represents an
inactive \gls{sftsLabel} subsystem with an active \gls{medfsmLabel}.
\texttt{101} represents a warming-up solar field while vacuum is being
generated in the \gls{medLabel} system.

\blindtext\blindtext

\begin{marginfigure}[-3cm]
    \includegraphics[]{figures/solarmed-modelling-complete_model.png}
    \caption{Complete \gls{solarmedLabel} model architecture. TODO: Needs to be
    updated}
    \labfig{solarmed:modelling:complete_model}
\end{marginfigure}


\subsection{Validation}

% Gráfica tocha mostrado algún día y después una tabla para varios días