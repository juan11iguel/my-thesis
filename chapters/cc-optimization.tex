\setchapterpreamble[u]{\margintoc}
\chapter{Optimization of a combined cooling system}
\labch{cc:optimization}

\tldrbox{
    This chapter describes optimization problems for a combined cooling system,
    a \gls{dcLabel} and a \gls{wctLabel} as well as different optimization
    strategies propositions to solve them. The objective is to minimize the
    daily cost of operation made up by the electricity and water costs, while
    ensuring the cooling demand is met. They key challenge is to manage the
    available water resource, since there is a limited amount of cheap
    rainwater available and any excess water required must be purchased at a
    significantly higher cost. From the alternatives, this can only be
    effectively achieved by the shrinking horizon optimization strategy applied
    to the combined cooler for which an implementation methodology is proposed.
}

\section*{Introduction}
% Recodatorio: No hace falta introducir mucho el contexto porque eso es algo
% que ya se habrá hecho en la parte introductoria

% Estado del arte en optimización en sistemas de refrigeración
Over the years, various studies have compared wet and dry cooling systems for
\gls{cspLabel} plants. Most of these works are limited to studying the effect of
some operating parameters via a sensitivity analysis
\sidecite{asfand_thermodynamic_2020,mdallal_modelling_2024,hu_thermodynamic_2018,tang_study_2013,asvapoositkul_comparative_2014,barigozzi_performance_2014}
. Nonetheless, several have focused on improving cooling system performance
through optimization of the individual component operation. Among them, the
works from Martín et al. stand out. In \sidecite{martin_optimal_2013} they were
the first to optimize the year-round operation of a CSP system not only
considering the cooling side but also integrating the power block. The problem
was formulated as a multiperiod \gls{nlpLabel} problem with air flow rate and
outlet temperature as decision variables for the cooling system. They showed
that the obtained complex problem can feasibly be solved and an average water
consumption of 2.1 l/kWh was obtained with the least efficient month amounting
to 2.5 l/kWh. In \sidecite{martin_optimal_2015} the same strategy was applied
this time for a dry cooling alternative (\gls{accLabel}) and formulating the
optimization as a multiperiod \gls{minlpLabel} problem. This integer extension
to the problem was done to account for the addition of a new decision variable:
the discrete number of units and fans that make up the \gls{accLabel} \ie their
active state. The problem was solved via relaxation of the integer variables and
after evaluating the annual operation they found the optimized dry cooler
consumed around 5\% of the total generated power compared to 3.44\% of the wet
alternative, and increasing a cent the LCOE (0.16 vs 0.15 €/kWh, respectively).
A limitation of both studies is the use of monthly average values, which masks
the significant daily temperature variations—often exceeding 10$^\circ$C—that coincide
with peak power production and can have a substantial impact on cooling system
performance.


Two distinct configurations can be found in the literature where a discussion is
made about its operation strategy: water-enhanced dry cooling and parallel configuration.
Rohani\todo{Realmente lo que proponen no es nada nuevo, exactamente esa
operación ya se propuso por ejemplo en wiles\_description\_1978 y zaloudek\_study\_1976}
et al. \sidecite{rohani_optimization_2021} and Golkar et al
\cite{golkar_determination_2019}. In the latter, Rohani et al. implement a
thorough model of water streams in a \gls{cspLabel} plant that was
experimentally validated. Different scenarios and cooling alternatives were
analyzed and each of them was simulated for a year of operation. In the hybrid
configuration the operation strategy consisted on always prioritizing the dry
sections up until a set value in the condenser pressure was reached, in which
case the wet units activated. This strategy offers a simple and robust solution
but leaves a lot of performance on the table. Water will be left unused despite
potentially being available to prioritize the more expensive dry cooler
operation. While Golkar et al \cite{golkar_determination_2019} delved more in
the design and sizing of the hybrid cooler by application of a genetic
algorithm, it then applied a very similar operation strategy.

In Maulbetsch et al.~\cite{maulbetsch_economic_2012}, a parallel combined system
is analyzed, where the operation strategy is set as follows: At some
temperature, the condensing pressure achieved will raise above a desired limit.
For ambient temperatures above that level, both systems are operated at full
design fan power. When the condensing pressure is below that limit, the capacity
of the wet section is reduced to maintain it while the dry section is operated
at full capacity. At lower temperature where the dry section can maintain the
condensing pressure by itself, the wet system is no longer operated. Finally, at
even lower temperatures, the fan power is gradually reduced on the dry section.

% Limitaciones en literatura
One inherent limitation that no optimization strategy can fully overcome is the
seasonal mismatch between temperature and water availability. In many locations,
ambient temperatures are lowest—favoring dry cooling—during times of the year
when water is most abundant—favoring wet cooling. The opposite occurs during
hot, dry summer periods, when cooling demand is highest but water becomes a
scarce resource.
Many studies report annual water savings figures, but this does not offer
a complete picture and can be misleading, as it may mask poor performance during
critical periods. Reducing water use during times of abundance, while failing to
achieve significant savings during water-scarce periods, does not represent an
optimal solution—even if total annual water consumption appears lower.
Significant cost savings can be achieved with increasing water availability,
either from  the specification of a smaller condenser or by lowering operating
turbine exhaust pressures (increasing the wet ratio).
In conclusion, there remains significant potential for improved water management
through optimized system operation, particularly when resource availability is
explicitly considered in the decision-making process:

\begin{itemize}
    \item Humidity is higher at night where ambient temperatures are lower,
    partially alleviating the limitations of the dry system and making it less
    unfavorable. 
    \item Take full advantage of the cheaper and more efficient wet cooling when
    water is plentiful.
    \item Consider the availability of alternative water sources and their
    dynamic costs.
    \item When using a combined cooling system its operation is not trivial but
    inherently becomes more complex; thus requiring an operation strategy to, at
    a minimum, robustly satisfy the cooling demand, but preferably also minimize
    the cost of operation.
\end{itemize}

\begin{marginfigure}[] % +5.5cm
    \includegraphics[]{figures/cc-optimization-environment.png}
    \caption{Block diagram of the optimization scheme including environment components}
    \labfig{cc:optimization:environment}
\end{marginfigure}

% Contribución de este capítulo
This chapter analyzes the optimization of different cooling system
configurations, focusing on their two primary resource consumptions: electricity
and water. The optimization problems are formulated to minimize the total cost
of cooling a thermal load, with cost defined as the combined use of these two
resources. The thermal load is treated as an external requirement and is therefore
excluded from the decision space. This work addresses existing limitations in
the literature and presents, for the first time, an actual optimization of the
operation of a combined cooling system in the context of \gls{cspLabel}
applications.\sidenote{Although the proposed methodology is applicable to any
system requiring thermal load cooling, particular emphasis is placed on water
resource availability, given its critical importance in solar thermal
applications.\\See \nrefsec{intro:csp:cooling}}

% Estructura de este capítulo
The chapter is structured as follows: first, the environment definition is
presented in \nrefsec{cc:optimization:environment}, which includes a
description of the variables taking part in the costs context, weather
forecast, thermal load, and water resource availability. Next the two
optimization strategies are presented, first a static optimization in
\nrefsec{cc:optimization:static} where the dry cooler, wet cooler and combined
cooler static problems are defined; followed by a shrinking horizon
optimization approach in \nrefsec{cc:optimization:horizon} where the
combined cooler is optimized over a prediction horizon. This last section
includes a discussion on the problem nature and then presents the proposed
methodology to solve it.


%===================================
%===================================
\section{Environment description}
\labsec{cc:optimization:environment}

The environment for the optimization problems described in this section
includes the following components and is visualized in \reffig{cc:optimization:environment}:

\begin{enumerate}
    \item \textbf{Costs context} The cooling system has mainly two associated
    operational costs: electricity ($J_e$) and water use ($J_w$). For the
    electricity the sale price of electricity ($P_e$) is used since whatever is
    consumed by the cooling system, it is electricity that cannot be sold to
    the market in the case of a system that produces electricity like a
    \gls{cspLabel} plant, and it is electricity that needs to be purchased at market
    price in the case of any other system. 
    
    As for the water, two sources are considered, water price from source 1 is
    referred as $P_{w,s1}$ and $P_{w,s2}$ for source 2. Source 1 is cheaper
    than source 2.

    \item \textbf{Weather forecast} The only two weather variables that have an impact
    on the cooling system are the ambient temperature ($T_{amb}$) and the
    relative humidity ($HR$) since they set the dry and wet bulb temperatures.

    \item \textbf{Thermal load} The thermal load is defined either by a vapor flow rate
    ($\dot{m}_v$) or a thermal power ($\dot{Q}$), which enters the condenser at
    a temperature $T_v$.\sidenote{Vapor can also be referred as steam, usually
    steam is used when the vapor performs work, like in a turbine.}
    
    \item \textbf{Water resource availability} Two sources of water are available, one
    of them, the cheaper one coming from a dam is limited in volume
    ($V_{avail}$). The cheaper source ($s_1$) is prioritized until it is
    depleted, then the alternative source ($s_2$) is used:

    \begin{align}
        & \quad C_{w,s1,i} = \frac{\min(V_{avail,i}, C_{w,i} \cdot T_s)}{T_s} \label{eq:cc:optimization:wa1} \\
        & \quad C_{w,s2,i} = C_{w,i} - C_{w,s1,i} \label{eq:cc:optimization:wa2} \\
        & \quad V_{avail,i} = V_{avail,i-1} - C_{w,s1,i} \cdot T_s \label{eq:cc:optimization:wa3}
    \end{align}

    where $i$ represents the step, at every step the amount used from each
    source is estimated and the source 1 availability is updated accordingly.
    $C_w$ represents the flow rate of water consumed and $T_s$ is the
    sample time at which steps are computed.
\end{enumerate}

% %================================
% \subsection{Water resource availability}
% \labsec{cc:optimization:environment-water}


\section{Static optimization}
\labsec{cc:optimization:static}

Static optimization problems are defined in a particular time, given an
environment, and decisions do not take into account prior states or decisions,
neither consider the effect on future state.

From a process perspective this also characterizes the cooling process, except for
the water resource availability, being the only variable that depends on the
previous state, \ie is not static. Each time a static problem is evaluated, it
begins with a specific initial water volume ($V_{\text{avail},0}$) for that
step. After solving the problem, this volume must be updated before proceeding
to the next step. As a result, evaluating multiple consecutive steps requires a
sequential approach.

\reminder{Optimization problem definition}{
    The general optimization function is defined as:\footnote{See \nrefsec{intro:optimization}}
    \begin{equation*}
    \min_{\mathbf{x},\, \mathbf{e};\, \boldsymbol{\theta}} \quad J = f(\mathbf{x}, \mathbf{e}; \boldsymbol{\theta}) 
        \quad \text{s.t.} \quad g_i(\mathbf{x}) \leq 0, \quad i = 1, \ldots, m
    \end{equation*}

    where \(x\) is the decision vector, \(e\) represents the environment, and \(\theta\) contains the fixed parameters.
}

In order to streamline the problem formulation, a general combined cooling
system model is used for every scenario. This unified model incorporates both
the dry and wet coolers, as well as the shared surface condenser. For cases
where only one cooler is used, the other can be effectively disabled by setting
its associated variables to zero and configuring the hydraulic circuit to
prevent water circulation through it.

%================================
\subsection{Dry cooler}
\labsec{cc:optimization:static:dc}

In the first case study, the optimization focuses exclusively on the dry
cooler. Consequently, all variables and terms associated with the wet cooler,
as well as water resource management, are omitted from the formulation, making
the problem completely static\sidenote{Achieved by setting $R_p=0$ and
$R_s$=0}. This configuration is illustrated in
\reffig{cc:optimization:diagram-dc} and the problem is defined as follows:


\marginnote[*5]{See \nrefsec{cc:modelling:dc} for a detailed description of the
dry cooler and \nrefsec{cc:modelling:condenser} for the condenser model.}

\problemdefinitionbox{\gls{dcLabel} - static}{
    \begin{equation*}
        \min_{\mathbf{x},\, \mathbf{e};\, \boldsymbol{\theta}} \quad J = f(\mathbf{x}, \mathbf{e}; \boldsymbol{\theta}) = C_e \cdot P_e
    \end{equation*}

    \textbf{with}:
    \begin{align*}
        T_{dc,out},\,C_e,\,T_{c,in},\,T_{c,out} &= \text{dcs\:model}(q_c,\,\omega_{\text{dc}},\, T_{\text{amb}},\, T_v,\, \dot{m}_v)
    \end{align*}
    \begin{itemize}
        \item Decision variables
        \[
        x = [q_c,\, \omega_{\text{dc}}]
        \]
        \item Environment variables
        \[
        e = [T_{\text{amb}},\, P_e,\, T_v,\, \dot{m}_v]
        \]
        \item Fixed parameters
        \[
        \theta = [R_p = 0,\, R_s = 0,\, \omega_{\text{wct}} = 0]
        \]

    \end{itemize}

    \textbf{subject to}:
    \begin{itemize}
        
        \item Box-bounds
        \begin{itemize}
                \item $w_{dc} \in [\underline{w}_{dc}, \overline{w}_{dc}]$
                % \item $w_{wct} \in [\underline{w}_{wct}, \overline{w}_{wct}]$
                \item $q_{c} \in [\underline{q}_{c}, \overline{q}_{c}]$
                % \item $R_p \in [0,1]$
                % \item $R_s \in [0,1]$
        \end{itemize}

        \item Constraints
        \begin{itemize}
            \item $\left| T_{\text{dc,out}} - T_{\text{c,in}} \right| \leq \epsilon_1$
            \item $T_{\text{c,out}} \leq T_v - \Delta T_{\text{c-v,min}}$
            \item $\left| Q_{\text{dc}}- Q_{\text{c,released}} \right| \leq \epsilon_2$
        \end{itemize}

    \end{itemize}
    }

\begin{marginfigure}[*-20]
    \includegraphics[]{figures/wascop-optimization-dc-diagram.png}
    \caption{Diagram of the dry cooler only cooling problem}
    \labfig{cc:optimization:diagram-dc}
\end{marginfigure}

The cost of cooling ($J$) is equivalent to the cost of electricity ($J_e$),
which in turn is the product of the electricity price ($P_e$) and the
electricity consumption ($C_e$). Only two decision variables are defined, the
cooling water recirculation flow rate ($q_c$) and the dry cooler fan speed
($\omega_{dc}$). Any two pair of values for these variables that satisfy the
bounds do not necessary yield a feasible solution, that is why three constrains
are introduced, the first one ensures that the outlet cooler temperature
matches the inlet condenser temperature (since they are directly connected,
they must be the same), the second one ensures that the condenser outlet
temperature respects the minimum temperature difference with the vapor
temperature, and the last one ensures that the cooling duty of the dry cooler
matches the one of the condenser.\sidenote[][*-4]{In order to better comprehend why
mismatches between cooler and condenser can exist, the reader is referred to
\nrefsec{cc:modelling:complete-model}}.


%================================
\subsection{Wet cooler}
\labsec{cc:optimization:static:wct}

Conversely to the dry cooler, the wet cooler optimization problem is configured
by setting $R_p=1$, effectively disabling the dry cooler. In this case, water
associated variables are included in the problem formulation:\sidenote{See
\nrefsec{cc:modelling:wct} for a detailed description of the wet cooler and
condenser model.}

\problemdefinitionbox{\gls{wctLabel} -- static}{
    \begin{equation*}
        \min_{\mathbf{x},\, \mathbf{e};\, \boldsymbol{\theta}} \quad J = f(\mathbf{x}, \mathbf{e}; \boldsymbol{\theta}) = J_e + J_w
    \end{equation*}

    \textbf{with}:
    \begin{align*}
        J_e &= C_e \cdot P_e \\
        J_{w} &= C_{w,s1} \cdot P_{w,s1} + C_{w,s2} \cdot P_{w,s2} \\
        C_{w,s1} &= \min \left((V_{avail}, C_{w} \cdot T_s)/T_s \right) \\
        C_{w,s2} &= C_w-C_{w,s1} \\
        T_{wct,out},\,C_e,\,C_w,\,T_{c,in},\,T_{c,out}&=\text{wcs\:model}(q_c, \omega_{wct},T_{amb},HR,T_{v},\dot{m}_v)
    \end{align*}
    \begin{itemize}
        \item Decision variables
        \[
        x = [q_c,\, \omega_{\text{wct}}]
        \]
        \item Environment variables
        \[
        e = [T_{\text{amb}}, HR,\, P_e,\, P_{w,s1},\, P_{w,s2}, V_{avail},\, T_v,\, \dot{m}_v]
        \]
        \item Fixed parameters
        \[
        \theta = [R_p = 1,\, R_s = 0,\, \omega_{\text{dc}} = 0]
        \]

    \end{itemize}

    \textbf{subject to}:
    \begin{itemize}
        
        \item Box-bounds
        \begin{itemize}
                \item $w_{wct} \in [\underline{w}_{wct}, \overline{w}_{wct}]$
                % \item $w_{wct} \in [\underline{w}_{wct}, \overline{w}_{wct}]$
                \item $q_{c} \in [\underline{q}_{c}, \overline{q}_{c}]$
                % \item $R_p \in [0,1]$
                % \item $R_s \in [0,1]$
        \end{itemize}

        \item Constraints
        \begin{itemize}
            \item $\left| T_{\text{wct,out}} - T_{\text{c,in}} \right| \leq \epsilon_1$
            \item $T_{\text{c,out}} \leq T_v - \Delta T_{\text{c-v,min}}$
            \item $\left| Q_{\text{wct}} - Q_{\text{c,released}} \right| \leq \epsilon_2$
        \end{itemize}

    \end{itemize}
}

\begin{marginfigure}[*-20]
    \includegraphics[]{figures/wascop-optimization-wct-diagram.png}
    \caption{Diagram of the wet cooler only cooling problem}
    \labfig{cc:optimization:diagram-wct}
\end{marginfigure}

In this version of the problem, the decision vector is composed by the
recirculation flow rate, but now the fan speed of the wet cooler
($\omega_{wct}$) is included. The cost of cooling now includes the cost of
water ($J_w$) and its availability is updated using the water consumption
($C_{w}$) as described in
Equations~\eqref{eq:cc:optimization:wa1}--\eqref{eq:cc:optimization:wa3}. The
environment now includes the air relative humidity and water prices.


%================================
\subsection{Combined cooler}
\labsec{cc:optimization:static:cc}

The last static optimization problem is the combined cooler, which incorporates
both the dry and wet coolers, as well as the condenser. Here the hydraulic
distribution is not fixed but is part of the decision variables, allowing the
optimization to determine the optimal distribution between the two coolers. The
problem is defined as follows:\sidenote{
    See~\nrefsec{cc:modelling:complete-model} for a detailed description of the
    combined cooler and condenser model.
}

\problemdefinitionbox{\gls{ccLabel} - static}{
    \begin{equation*}
        \min_{\mathbf{x},\, \mathbf{e};\, \boldsymbol{\theta}} \quad J = f(\mathbf{x}, \mathbf{e}; \boldsymbol{\theta}) = J_e + J_w
    \end{equation*}

    \textbf{with}:
    \begin{align*}
        J_e &= C_e \cdot P_e \\
        J_{w} &= C_{w,s1} \cdot P_{w,s1} + C_{w,s2} \cdot P_{w,s2} \\
        C_{w,s1} &= \frac{\min(V_{avail}, C_{w} \cdot T_s)}{T_s} \\
        C_{w,s2} &= C_w-C_{w,s1} \\
        T_{cc,out},\,C_e,\,C_w,\,T_{c,in},\,T_{c,out}&=\text{ccs\:model}(q_c, R_p, R_s, \omega_{dc}, \omega_{wct},T_{amb},HR,T_{v},\dot{m}_v)
    \end{align*}
    \begin{itemize}
        \item Decision variables
        \[
        x = [q_c, R_p, R_s, \omega_{\text{dc}}, \omega_{\text{wct}}]
        \]
        \item Environment variables
        \[
        e = [T_{\text{amb}}, HR,\, P_e,\, P_{w,s1},\, P_{w,s2}, V_{avail},\, T_v,\, \dot{m}_v]
        \]

    \end{itemize}

    \textbf{subject to}:
    \begin{itemize}
        
        \item Box-bounds
        \begin{itemize}
                \item $w_{dc} \in [\underline{w}_{dc}, \overline{w}_{dc}]$
                \item $w_{wct} \in [\underline{w}_{wct}, \overline{w}_{wct}]$
                \item $q_{c} \in [\underline{q}_{c}, \overline{q}_{c}]$
                \item $R_p \in [0,1]$
                \item $R_s \in [0,1]$
        \end{itemize}

        \item Constraints
        \begin{itemize}
            \item $\left| T_{\text{cc,out}} - T_{\text{c,in}} \right| \leq \epsilon_1$
            \item $T_{\text{c,out}} \leq T_v - \Delta T_{\text{c-v,min}}$
            \item $\left| Q_{\text{cc}} - Q_{\text{c,released}} \right| \leq \epsilon_2$
        \end{itemize}

    \end{itemize}
}

\begin{marginfigure}[*-20]
    \includegraphics[]{figures/wascop-optimization-cc-diagram.png}
    \caption{Diagram of the combined cooler and condenser problem}
    \labfig{cc:optimization:diagram-cc}
\end{marginfigure}
% TODO: Add a background color that depends on the cooling color provided by
% each cooler, this way it can be visualized how the cooling contribution
% changes
\begin{marginfigure}[*-5]
    \includegraphics[]{figures/cc-optimization-pareto.png}
    \caption{Pareto front for a particular problem instance of the combined cooler optimization problem.}
    \labfig{cc:optimization:pareto}
\end{marginfigure}

\reffig{cc:optimization:pareto}\todo{Add a background color antes del domingo} illustrates the various ways a combined cooler
can meet a specific cooling load under identical environmental conditions. The
optimal operating points—the Pareto front—are highlighted in the figure\marginreminder{Pareto front}{
    When dealing with multiple objectives where no single solution is optimal, but
    improvements in one objective lead to trade-offs in others, a set of points is
    obtained that represents the best trade-offs between the objectives—known as a
    Pareto front\footnote{See \nrefsec{intro:optimization:multi-objective}}.
}. The background color represents the distribution of cooling power: green
indicates a greater contribution from the dry cooler, while purple indicates a
greater contribution from the wet cooler. Notably, only the leftmost point
relies exclusively on the dry cooler. Moving even slightly to the right results
in a rapidly increasing contribution from the wet cooler.


\section{Horizon optimization}
\labsec{cc:optimization:horizon}

The problem structure is very similar to the static alternative, the main
difference is that now the decision and environment vectors are composed not
from the expected value for the optimization step, but an array of values from
the current optimization step ($i$) until the end of the prediction horizon
($n_{steps}$)\sidenote{
    Bold notation is used to indicate that the variable is an array and not a
    single value, \eg $\mathbf{x}$
}:

\marginnote[*5]{$\forall i = 1 \ldots n_{steps}$ is a notation to indicate that
    a condition must be held at every step $i$ in the optimization horizon
    ($n_{steps}$)}

\problemdefinitionbox{\gls{ccLabel} - horizon}{
    \begin{equation*}
        \min_{\mathbf{x},\, \mathbf{e};\, \boldsymbol{\theta}} \quad J = f(\mathbf{x}, \mathbf{e}; \boldsymbol{\theta}) = \sum_{i=1}^{n_{steps}} \left( J_{e,i} + J_{w,i} \right) \cdot T_s
    \end{equation*}

    \textbf{with}:
    \begin{align*}
        \quad for\: i &= 1 \ldots n_{steps}: \\
        & \quad J_{e,i} = C_{e,i} \cdot P_{e,i} \\
        & \quad J_{w,i} = C_{w,s1,i} \cdot P_{w,s1,i} + C_{w,s2,i} \cdot P_{w,s2,i} \\
        & \quad C_{w,s1,i} = \frac{\min(V_{avail,i}, C_{w,i} \cdot T_s)}{T_s} \\
        & \quad C_{w,s2,i} = C_{w,i}-C_{w,s1,i} \\
        & \quad V_{avail,i} = V_{avail,i-1}-C_{w,s1,i}\cdot T_s \\
        & \quad T_{cc,out,i},\,C_{e,i},\,C_{w,i},\,T_{c,out,i}=f(q_{c,i}, R_{p,i}, R_{s,i}, \omega_{dc,i}, \omega_{wct,i},T_{amb,i},HR_i,T_{v,i},\dot{m}_{v,i})
    \end{align*}
    \begin{itemize}
        \item Decision variables
        \[
        \mathbf{x} = [\mathbf{q_c}, \mathbf{R_p}, \mathbf{R_s}, \boldsymbol{\omega}_{\text{dc}}, \boldsymbol{\omega}_{\text{wct}}]
        \]
        where $x=[x_{1,1},\,\ldots\, x_{1,n_{steps}},\, \ldots,\, x_{n_{x},n_{steps}}]$
        \item Environment variables
        \[
        \mathbf{e} = [\mathbf{T_{\text{amb}}}, \mathbf{HR},\, \mathbf{P_e},\, \mathbf{P_{w,s1}},\, \mathbf{P_{w,s2}}, \mathbf{V_{avail,0}},\, \mathbf{T_v},\, \mathbf{\dot{m}_v}]
        \]
        where $e=[e_{1,1},\,\ldots\, e_{1,n_{steps}},\, \ldots,\, e_{n_{e},n_{steps}}]$

    \end{itemize}

    \textbf{subject to}:
    \begin{itemize}
        
        \item Box-bounds
        \begin{itemize}
                \item $\mathbf{w_{dc}} \in [\underline{w}_{dc}, \overline{w}_{dc}]$
                \item $\mathbf{w_{wct}} \in [\underline{w}_{wct}, \overline{w}_{wct}]$
                \item $\mathbf{q_{c}} \in [\underline{q}_{c}, \overline{q}_{c}]$
                \item $\mathbf{R_p} \in [0,1]$
                \item $\mathbf{R_s} \in [0,1]$
        \end{itemize}

        \item Constraints, $\forall i = 1 \ldots n_{steps}$:
        \begin{itemize}
            \item $\left| T_{\text{cc,out},i} - T_{\text{c,in},i} \right| \leq \epsilon_1$
            \item $T_{\text{c,out},i} \leq T_{v,i} - \Delta T_{\text{c-v,min}}$
            \item $\left| Q_{\text{cc},i} - Q_{\text{c,released},i} \right| \leq \epsilon_2$
        \end{itemize}

    \end{itemize}
}

This formulation allows for an arbitrary long prediction horizon, however,
since forecasts for each variable in the environment are needed, it will be
limited to a number of steps where reliable predictions can be obtained. On
this work water availability is allocated daily, so the prediction horizon is
established until the end of the operation day and it starts from the current
time when the optimization is launched.

% \begin{enumerate} 
%     \item An operation plan of the thermal load (power block or MED operating
%     conditions) needs to be defined.
%     \item An estimation of the costs context evolution. Water price is unlikely
%     to change often, but electricity can be more dynamic, specially market prices.
%     \item 
% \end{enumerate}

%================================
\subsection{A discussion on solving the optimization problem}[Problem discussion]

\begin{marginfigure}
    \includegraphics[]{figures/optimization-diagrams-search-space.png}
    \caption{Visualization of a constrained search space for two decision variables}
    \labfig{cc:optimization:search-space}
\end{marginfigure}

% Aquí comentar cómo no es factible resolver el problema directamente porque es
% muy difícil encontrar soluciones factibles debido a la estructura del problema.

% Comentar número de elementos en el vector de decisión, crecimiento exponencial
% de la complejidad del problema con el número de pasos en el horizonte, etc..

As defined, the \gls{ccsLabel} problem decision vector is composed by five
variables that are direct inputs on the process\sidenote{\ie Decision variables
represent actuators in the system}. But as mentioned, not any five values for
these variables will yield a feasible solution, in the real system this
translates to the fact that a stable operation \ie steady-state would never be
reached for that set of inputs. To check for feasible operation the three
mentioned constraints are introduced, however, this increases the complexity of
the solution space significantly, since the solution space will not be
continuous, but as seen in \reffig{cc:optimization:search-space}, it will be
formed by islands of feasible solution space regions separated by infeasible
regions. This means that finding a feasible solution is not trivial, and the
optimization algorithm will need to explore the solution space-a global search
algorithm-in an attempt to find the global minimum.

For one single step, most global search algorithms with multiple runs\sidenote{
    Tried algorithms include: Algoritmos probados de pygmo y Poner Gaussian también
} were able to consistently find the global optima, this was not the case
    for local gradient-based algorithms, which were very sensible to the
    initial conditions and often converged to local minima, even when coupled
    with other techniques, such as Generalized Monotonic Basin Hopping
    \sidecite{wales_global_1997}, they struggled to consistently escape these
    local optima.

The problem becomes significantly more complex when the prediction horizon is
extended, the decision vector grows five-fold for each additional step in the
prediction horizon, and the optimization algorithm is tasked with finding a
feasible solution for this much larger decision vector, in a very complex
solution space, at once for all steps. The chances of finding a feasible
solution decrease significantly, and this was reflected in the failure to find
a single feasible solution. Even when providing an initial guess composed by
the static problem solutions for each step in a 24 steps horizon, the returned
solution was that same initial guess.


%================================
\subsection{Proposed solution: Decomposition-based multi-objective optimization with trajectory planning}[Proposed solution]

A two-level optimization strategy is proposed to solve a multi-step decision
problem\sidenote[][*-3]{Alternative wording: Pareto front chaining, multi-step
Pareto optimization, path planning on Pareto surfaces.}. At each step of the
prediction horizon, a multi-objective optimization problem is independently
solved, yielding a Pareto front. A global optimization problem is then
formulated to select a path through the sequence of Pareto fronts, minimizing a
cumulative objective (\ie, cost), akin to a pathfinding or \gls{tspLabel}-like
over Pareto-optimal points.

The methodology is illustrated in \reffig{cc:optimization:horizon-methodology}
and its components are described in the following sections.

\begin{figure*}[h!]
    % \begin{flushleft}
    %     {\textbf{0.} Decompose the problem horizon into its $n$ steps elements.}
    % \end{flushleft}
    % \vspace{1ex}

    % \begin{flushleft}
    % {\textbf{1.} Solve a multi-objective optimization problem,
    % independently for each step, to obtain a set of pareto fronts:}
    % \end{flushleft}
    % \vspace{0.5ex}
    % \includegraphics[]{figures/optimization-diagrams-paretos.png}
    % \vspace{1ex}

    % \textdownarrow

    % \begin{flushleft}
    % {\textbf{2.} Select a path through these
    % pareto fronts that minimizes a global objective: the cumulative operation
    % cost of operation}
    % \end{flushleft}
    % \vspace{0.5ex}
    % \includegraphics[]{figures/optimization-diagrams-path-selection.png}
    % % \vspace{1ex}
    \includegraphics[]{figures/cc-horizon-optimization-diagram.png}

    \caption[Proposed methodology. Decomposition-based multi-objective
    optimization with trajectory planning]{Proposed methodology.
    Decomposition-based multi-objective optimization with trajectory planning.
    \textcolor[HTML]{6C8EBF}{\textit{Blue-dots} (\textbf{·})} represent
    points on the Pareto front. In step 2. three paths are illustrated: a water-greedy
    \textcolor[HTML]{9673A6}{dash-purple (- -) path}, a water-conservative
    \textcolor[HTML]{82B366}{green-dotted path (\texttt{..})} and a
    compromise-approach \textcolor[HTML]{FFCE9F}{solid-\textit{orangey} path
    (\texttt{--})}}
    \labfig{cc:optimization:horizon-methodology}
\end{figure*}

\subsubsection{Solving the multi-objective optimization problems}

To limit the complexity of the problem, the decision space can be reduced by
one by variable by analyzing how the complete model is solved and described in
\nrefsec{cc:modelling:complete-model}; firstly, the condenser can be solved
just by using the recirculation flow rate ($q_c$), it follows the dry cooler by
adding the first valve ratio ($R_p$) and dry cooler fan speed ($\omega_{dc}$).
The only remaining component to solve is the wet cooler. The wet cooler inlet
conditions ($q_{wct}$, $T_{wct,in}$) can be determined by using the second valve
ratio ($R_s$). As for the outlet conditions, from the condenser evaluation, its
inlet temperature is known and it sets the value of the combined cooler
outlet temperature ($T_{cc,out}$), which in turn is the result of the mixing from the \gls{dcLabel}
and \gls{wctLabel} outlet temperatures ($T_{dc,out}$ and $T_{wct,out}$,
respectively). 

The result of this analysis is that the wet cooler fan speed is not a decision
variable anymore, but an output of the model, which can be computed by inverting the
wet cooler model, where an outlet temperature is provided as input, and the fan
speed is computed as an output. Summarizing, the decision vector can be reduced
from five to four variables:\sidenote{This reasoning works only for a system
with this particular configuration, a different combined cooler layout would
require a different analysis.}

\begin{equation*}
    x = [q_c, R_p, R_s, \omega_{dc}]
\end{equation*}

More importantly, now the optimization algorithm does not need to find a set of
five inputs that produce a feasible solution in a complex solution space, but
only four values from which a feasible wet cooling tower fan speed
exists\sidenote{\ie within its bounds $\omega_{wct}\,\in
[\underline{\omega}_{wct}, \overline{\omega}_{wct}]$}, thus greatly simplifying
the problem.

A straightforward approach to solve the multi-objective optimization is to do a
grid-search over the decision space, evaluating the model for every combination
of decision variables, and then storing only the points for which a feasible
$\omega_{wct}$ exists. This approach is not recommended for large decision
spaces, but for the four-dimensional decision space and with a model that can
be evaluated in fractions of a second, it is feasible.

Next, the Pareto front is computed from the feasible points, which are
evaluated in terms of the two consumptions: electricity ($C_e$) and water
($C_w$). By definition, the Pareto front is the set of points that cannot be
improved in one objective without worsening the other, and it is computed by
checking for each point if there is another point that is better in both
objectives, and if so, it is removed from the set of feasible points. The
remaining points form the Pareto front. This process is repeated for
each step in the prediction horizon, resulting in a set of Pareto fronts, one
for each step, as visualized in
\reffig{cc:optimization:horizon-methodology}--\texttt{1}.


\subsubsection{Path selection subproblem}


The path selection subproblem is a combinatorial optimization problem over a 
layered weighted directed graph, where each layer corresponds to a 
time step in the prediction horizon, and each node in a layer represents a 
point on the corresponding Pareto front. The objective is to find a path 
\(\mathbf{p} = (p_1, p_2, \ldots, p_{n_{\text{steps}}})\), where \(p_i\) is the 
selected node at time step \(i\), that minimizes the total cumulative cost 
along the path (\(J\)). The problem can be formulated as:

\begin{equation*}
    \min_{\mathbf{p}} \quad J = \sum_{i=1}^{n_{\text{steps}} - 1} 
    C_{\text{transition}}(p_i, p_{i+1})
\end{equation*}

Each transition cost \(C_{\text{transition}}(p_i, p_{i+1})\) depends on both
consumptions (\ie electricity and water consumption) of the nodes \(p_i\) and
\(p_{i+1}\), as well as a dynamic price function that depends on the path
history. Specifically, the transition cost is correlated to the current
resource availability ($V_{avail,i}$)\sidenote{See
Equations~\eqref{eq:cc:optimization:wa1}--\eqref{eq:cc:optimization:wa3}} and
will depend on the current state of the system, which is a function of the
previous decisions. This is a very simple calculation that can be computed
almost instantly, and it is the only information needed to compute the
transition costs between two points in the Pareto front:

\begin{equation*}
    C_{\text{transition}}(p_i, p_{i+1}) = P_e(i) \cdot C_e(p_{i+1}) + 
    P_w(i) \cdot C_w(p_{i+1})
\end{equation*}

where:
\begin{itemize}
    \item \(C_{e}(p_{i+1})\), \(C_{w}(p_{i+1})\): electricity and water consumption at 
    node \(p_{i+1}\)
    \item \(P_e(i)\), \(P_{w}(i)\): price coefficients for 
    electricity and water at step \(i\), which may be dependent on the 
    previously selected nodes (\ie, the path so far)
\end{itemize}

Prices \(P_e(i), P_{w}(i)\) depend on prior path decisions, 
this introduces path-dependency into the cost function, and makes the 
problem non-trivial to solve via simple shortest path algorithms.
The problem could be handled via dynamic programming, graph search
(like Dijkstra or A*), or metaheuristics such as genetic algorithms.

The subproblem is illustrated in
\reffig{cc:optimization:horizon-methodology}--2. Each node represents a point
in the Pareto front of a step, and edges represent the transition costs between
these points, that is, the cumulative cost so far ($J_{0..i}$). Three paths are illustrated in
\reffig{cc:optimization:horizon-methodology}--2. The
\textcolor[HTML]{9673A6}{dash-purple (- -) path} 
is a path that chooses nodes with a high water use\sidenote{In
\reffig{cc:optimization:horizon-methodology}, nodes are ordered with increasing
values of \(C_w\) from bottom to top.}, so in the first split it can be seen it
achieves the lowest cost of operation, but also leaves the least water
available for the next steps, resulting in a higher total cost of operation. On
the other hand, the \textcolor[HTML]{82B366}{green-dotted path (\texttt{..})}
chooses the nodes with the lowest water use, this translates in a consistently
higher cost of operation and leaving some water available at the end of the
horizon. Because of the formulation of the problem, this is sub-optimal since
this unused water is considered lost. Finally, the
\textcolor[HTML]{FFCE9F}{solid-\textit{orangey} path (\texttt{--})} is a
compromise between the two, it uses water more efficiently, leaving no water
available at the end of the horizon and minimizing the overall cost of
operation.
